# Детекция автомобильных номерных знаков

**Автор:** Красюков Александр

---

## Постановка задачи

Разработка системы автоматизированного мониторинга и анализа автомобильного
трафика в периметрах охраняемых объектов на основе детекции номерных знаков
автомобилей.  
Система предназначена для накопления статистики и выявления подозрительной
активности (например, многократное появление или длительное нахождение) с целью
повышения уровня безопасности охраняемого объекта.

---

## Формат входных и выходных данных

**Входные данные:**  
Изображения автомобилей (видеокадры, снимки камер видеонаблюдения, форматы JPG,
PNG).

**Выходные данные:**  
Изображения с выделенными прямоугольниками вокруг обнаруженных номерных знаков и
файл с координатами ограничивающих рамок в формате JSON или TXT.

---

## Метрики качества

Для оценки качества модели используется **mAP50** (mean Average Precision при
IoU=0.5).  
Цель:

- mAP50 > 0.95
- Основной упор делается на баланс между точностью и количеством ложных
  срабатываний.

---

## Валидация и тест

Разделение данных выполняется с помощью функции `train_test_split` из библиотеки
**scikit-learn** с фиксированным `random_state` для обеспечения
воспроизводимости.  
Данные делятся на три выборки:

- **Тренировочная** — 60%
- **Валидационная** — 20%
- **Тестовая** — 20%

---

## Датасеты

### 1. Детекция номерных знаков (Kaggle)

- **Источник:**
  [Kaggle: YOLOv12n Video Plate Detection](https://www.kaggle.com/code/khnhtonnguyn/yolov12n-video-plate-detection-train-predict/output)
- **Объем:** ~8,800 изображений + 8 видеороликов
- **Особенности:** данные собраны в разнообразных городских условиях,
  преобладают европейские и азиатские номера
- **Проблемы:** сильная вариативность ракурсов, освещения и масштаба;
  необходимость конвертации разметки в единый формат

---

## Моделирование

### Базовая модель

В качестве бейзлайна можно использовать предобученные модели из библиотеки
**TorchVision** для детекции объектов (например, Faster R-CNN с ResNet).  
Бейзлайн позволит проверить корректность пайплайна обучения и валидации.

---

### Основная модель

**Модель:** Faster R-CNN с бэкбоном **MobileNetV3**

**Процесс обучения:**

1. Использую предобученные веса на датасете **COCO**.
2. Провожу дообучение модели на целевом датасете автомобильных номеров.

**Гиперпараметры:**  
Оптимизирую скорость обучения (learning rate), размер батча и параметры
аугментации.

**Предобработка данных**

На текущем этапе используется минимальный набор преобразований без аугментаций:

- Изменение размера изображения до фиксированного разрешения
- Масштабирование координат bounding box под новый размер
- Преобразование изображения в тензор
- Нормализация по заданным средним значениям и стандартным отклонениям

**Валидация:**  
Контроль качества модели осуществляется на отдельной валидационной выборке для
предотвращения переобучения.

## Setup

### 1. Клонирование и зависимости

> git clone git@github.com:MrASK2024/scan-car-plate.git cd scan-car-plate

#### 1.1. Создание окружения Miniconda

> conda create -n scan-car-plate python=3.12 conda activate scan-car-plate

#### 1.2. Установка зависимостей

> poetry install --with dev Установите PyTorch по ссылке в зависимости от вашей
> CUDA/ОС: https://pytorch.org/get-started/locally/

### 2. MLflow сервер (для трекинга)

> mlflow server --host 127.0.0.1 --port 8080 интерфейс будет доступен по адресу:
> http://127.0.0.1:8080

### 3. Проверка Code Quality

> pre-commit install pre-commit run -a

## Train

### 1. Запуск обучения

> python scan_car_plate/train.py

При запуске скрипта выполняются:

- `dvc pull` (см. `dvc_utils.py`)
- логирование метрик и параметров в MLflow

### 2. Гибкая настройка (Hydra Overrides)

Все параметры можно настраивать **через командную строку** или **в
конфигурационных файлах**.

Примеры CLI-оверрайдов:

> python scan_car_plate/train.py model.optimizer.lr=3e-4

> python scan_car_plate/train.py data.train_batch_size=8

> python scan_car_plate/train.py num_epochs=50

Альтернативно — редактируйте `conf/config.yaml` и перезапускайте обучение.  
Полный список параметров находится в `conf/config.yaml` и подпапках конфигов
Hydra.

### 3. Мониторинг экспериментов

- MLflow: http://127.0.0.1:8080 (experiment: car_plate_detection)

Логируемые сущности:

- Metrics: train_loss_epoch, val_map_50, val_mar_100
- Hyperparams: lr, weight_decay, iou_thresholds, train_batch_size,
  predict_batch_size, num_classes
